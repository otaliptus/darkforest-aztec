# Devnet Deployment Plan (Aztec Dark Forest)

## Purpose
Provide a step-by-step plan to deploy Dark Forest + NFT to Aztec devnet, enable fee sponsorship, and host the client cheaply.

## Devnet facts (v3.0.0-devnet.20251212)
- RPC: `https://next.devnet.aztec-labs.com`
- Explorer: `https://devnet.aztecscan.xyz`
- Sponsored FPC: `0x1586f476995be97f07ebd415340a14be48dc28c6c661cc6bdddb80ae790caa4e`
- Fees are always enabled, there are no pre-deployed test accounts, and block times are ~36s.

## Fee sponsorship options
- **Sponsored FPC (recommended)**: Free transactions on devnet without funding a Fee Juice balance.
- **Fee Juice**: Fund an account and pay fees directly (not needed for a cheap devnet demo).
- **Other FPCs**: Private/public FPCs for custom fee logic (optional).

Aztec.js flow for Sponsored FPC (summary):
- Derive SponsoredFPC instance from salt `0` and register it with the wallet.
- Use `SponsoredFeePaymentMethod` when sending txs.

This repo’s deploy script (`packages/contracts/scripts/deploy_devnet.js`) automatically uses `SponsoredFeePaymentMethod`
when `SPONSORED_FPC_ADDRESS` is provided.

## Prereqs
- Aztec CLI installed and synced to devnet version:
  - `aztec-up 3.0.0-devnet.20251212`
- Node + Yarn (repo uses Yarn classic).

## Deploy contracts (repo scripts)
1) Install dependencies:
   - `yarn install`
2) Compile contracts:
   - `yarn contracts:compile`
   - Optional smaller public bytecode: `DF_ENABLE_ADMIN_ACTIONS=0 yarn contracts:compile`
3) Set environment variables:
   - `AZTEC_NODE_URL=https://next.devnet.aztec-labs.com`
   - `SPONSORED_FPC_ADDRESS=0x1586f476995be97f07ebd415340a14be48dc28c6c661cc6bdddb80ae790caa4e`
   - `PROVER_ENABLED=true`
   - Account selection (choose one):
     - `ACCOUNT_SECRET` + `ACCOUNT_SALT` + `ACCOUNT_SIGNING_KEY` (recommended for a stable account)
     - `ACCOUNT_MODE=random` (ephemeral)
     - `ACCOUNT_INDEX=<n>` (if you have pre-provisioned accounts)
   - Optional config overrides:
     - `DF_WORLD_RADIUS`, `DF_PLANET_RARITY`, `DF_TIME_FACTOR_HUNDREDTHS`
     - `DF_INIT_X`, `DF_INIT_Y`, `DF_INIT_RADIUS`, `DF_REVEAL_X`, `DF_REVEAL_Y`
     - `DF_BLOCK_TIME_SEC=36`
4) Deploy:
   - `node packages/contracts/scripts/deploy_devnet.js --write-env --overwrite-env`
   - This deploys NFT + DarkForest, sets the NFT minter, and writes `apps/client/.env.local`.

## Client build + hosting (cheap)
- Build the UI: `yarn client:build`
- Deploy `apps/client/dist` to a static host (Netlify or Cloudflare Pages).
- The client config is baked at build time (webpack), so rebuild if `.env.local` changes.
- Netlify config lives at `apps/client/netlify.toml`.

## Optional snapshot (faster client load)
Generate a snapshot so the client avoids heavy public storage reads on first load:
- `node packages/contracts/scripts/indexer_snapshot.js --rpc $AZTEC_NODE_URL --contract $VITE_DARKFOREST_ADDRESS --nft $VITE_NFT_ADDRESS --out apps/client/public/snapshot.json`
- Add to `apps/client/.env.local` before the build:
  - `DF_SNAPSHOT_URL=/public/snapshot.json`
- Rebuild and redeploy the static site if you regenerate the snapshot.

## Phase 2: Alternative deployment track (no-prover, local network)
Run a second deployment track with proofs disabled for fast iteration and demos. Constraint: no-prover mode is supported only on the local Aztec network because devnet enforces proofs.

1) Start a local Aztec network:
   - `aztec start --local-network --node --sequencer --pxe --archiver`
2) Deploy without proofs:
   - `PROVER_ENABLED=false node packages/contracts/scripts/deploy_local.js --write-env --overwrite-env`
   - Optional fast map: `DF_SMALL_MAP=1 PROVER_ENABLED=false node packages/contracts/scripts/deploy_local.js --write-env --overwrite-env`
3) Run the client (local):
   - `yarn client:dev`
4) Optional snapshot for faster reloads:
   - `scripts/df-local.sh --deploy --run-client --snapshot`

Notes:
- Keep `VITE_PROVER_ENABLED=false` in the local `.env.local` generated by the deploy script.
- Keep config overrides aligned with devnet for consistent gameplay.

## Verification checklist
- Open the UI, connect, and run: join → reveal → move → prospect → find artifact → trade.
- Verify transactions + NFT mint on `https://devnet.aztecscan.xyz`.
- Capture turn time with: `node packages/contracts/scripts/bench_move.js --deploy`.

## Troubleshooting
- Devnet txs can time out while still mining; check the explorer before retrying.
- If Sponsored FPC is unavailable, remove `SPONSORED_FPC_ADDRESS` and fund Fee Juice.
- If the client renders mismatched planets, re-run the deploy script and rebuild the UI.

## References
- Devnet setup: `https://docs.aztec.network/developers/getting_started_on_devnet`
- Paying fees + Sponsored FPC: `https://docs.aztec.network/developers/docs/aztec-js/how_to_pay_fees`
- Network constants (RPC + Sponsored FPC): `https://docs.aztec.network/networks`
