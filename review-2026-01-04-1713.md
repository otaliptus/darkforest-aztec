# Dark Forest on Aztec — Repo Review (2026-01-04 17:13)

## Update (2026-01-04 20:42)
- **E2E flow now passes** on a local Aztec network using `SEQ_ENFORCE_TIME_TABLE=false` (tx-driven block production) with `tick_block` fallback; runtime was **~484s (~8.1 min)** end-to-end.
- **P0 parity is complete**, including spaceship activation parity (ticket 026).
- **Admin RPC is still not reachable** on `--local-network` (even with port mapping), so empty-block config via `nodeAdmin_setConfig` remains unavailable; empty-block attempts must be done via node config before startup (and were unstable when forcing `minTxsPerBlock=0`).

## Snapshot / Current Stage
The repo is in a **late integration** stage: core Noir contract logic for Dark Forest v0.6 is present, a headless E2E flow exercises the full gameplay API surface, and the client integration exists but still needs full gameplay-loop verification. The project is **past initial porting** and into **parity + correctness + polish**.

In short: **the spine of the game is here**, P0 parity is complete, the E2E flow passes on a local network, and the remaining risks are correctness edges, NFT burn semantics clarity, and end-to-end UX/observability.

## What’s Implemented / Working
- **Core gameplay mechanics are implemented in Noir** (init/reveal/move/resolve, upgrades, prospecting, artifact find/activation, space ships, etc.). The main contract is large and feature-rich, aligning with the v0.6 core loops.
- **Artifacts + spacetime rips + NFT plumbing exist** in contracts (artifact types, activation branches, and NFT contract dependency).
- **Headless E2E test** exercises nearly every gameplay entry point and asserts state transitions; it runs successfully against a local Aztec network (latest run: ~8.1 min end-to-end).
- **Local-network setup** is functional using the Aztec CLI; E2E can deploy DarkForest + NFT contracts and walk the full flow.

## Concrete File-Level Findings (Evidence)
- `packages/contracts/src/main.nr`:
  - Implements private→public state transition pattern for all core actions (`init_player`, `reveal_location`, `move`, `resolve_arrival`, `upgrade_planet`, `prospect_planet`, `find_artifact`, `trade_artifact`, `set_artifact_activation`, `give_space_ships`).
  - `apply_player_action` enforces init guard (cannot init on already initialized planet).
  - Wormhole arrival parity: `execute_arrival` skips combat damage for wormhole arrivals against enemy-owned planets.
  - Artifact burn semantics: bloom/black-domain activation sets `artifact.burned = true`, removes from planet artifacts, and writes `artifact_locations` to `config.max_location_id`.
  - NFT integration: `nft_mint`/`nft_transfer` internal helpers are used for artifact + ship mint/transfer flows.
- `packages/contracts/src/types.nr`:
  - `Artifact` includes activation timestamps + `burned` flag, and fixed-size `PlanetArtifacts` list.
- `packages/contracts/src/test/darkforest_stub.nr`:
  - Unit tests cover init/reveal/move/arrival, upgrade, prospect/find, trade/withdraw/deposit, wormhole parity, photoid timing, bloom/black burn, and spaceship move effects.
  - Explicit tests for init-guard, wormhole arrival parity, and burn semantics are present.
- `packages/nft/src/main.nr`:
  - Aztec-native NFT contract with `mint`, `transfer_in_public`, and `burn`.
  - DarkForest currently uses `transfer_in_public` to the contract address for burns (not `burn()`).
- `packages/contracts/scripts/e2e_darkforest.js`:
  - Headless flow validates on-chain state transitions + NFT ownership for all key actions.
  - Uses direct public-storage reads via storage-layout metadata to assert correctness.
  - Works on local network with `tick_block` fallback when admin RPC is unavailable.
- `packages/contracts/scripts/deploy_local.js`:
  - Local deploy for NFT + DarkForest and writes `.env.local` for the client.
- `apps/client/src/scripts/darkforest.ts` + `apps/client/src/scripts/storage.ts` + `apps/client/src/scripts/chain.ts`:
  - Client reads on-chain config hashes, resolves contract artifacts, and exposes typed calls for all core actions.
  - Public-state reads decode planet/player/artifact/arrival data directly from storage slots.
  - **Gap**: `ArtifactState` in client does not yet include the `burned` flag (contract has 12 fields, client decodes 11).
- `apps/client/src/App.tsx`:
  - Functional “control-panel” UI wired to all gameplay transactions, but still needs full gameplay-loop validation to match v0.6 UX.

## Current Risks / Gaps
1. **Local-network admin RPC is not exposed** in `--local-network` mode (Aztec CLI): `nodeAdmin_*` is unavailable because local-network bypasses admin services. E2E uses `tick_block` fallback.
2. **Empty-block acceleration is not stable** on local-network: forcing `minTxsPerBlock=0` at boot caused local-network bootstrap failures (tx dropped by P2P node). Current stable setup uses tx-driven blocks with `SEQ_ENFORCE_TIME_TABLE=false`.
3. **NFT burn semantics are still ambiguous** (burn address vs. true `burn()`); E2E/client currently expect “contract address as burn.”
4. **Client artifact decode gap**: client doesn’t read `Artifact.burned`, so UI/logic can’t reflect burn state yet.
5. **Performance target risk**: turn latency < 60s is not yet measured or enforced; current E2E run is ~8.1 minutes end-to-end on local (mostly waiting on block ticks).

## Repo-Wide Status (Observed Changes)
These reflect the current working tree and recent work:
- `packages/contracts/scripts/e2e_darkforest.js` — headless E2E flow updated and running; now uses `AZTEC_NODE_ADMIN_URL`, handles existing-nullifier deployment conflicts, and uses standard test accounts for local-network stability.
- `packages/contracts/scripts/hashing.js` — hashing utilities used by E2E/client for location generation (present and used in tests).
- `packages/contracts/package.json` — includes `test:e2e` script.
- `packages/contracts/src/main.nr`, `packages/contracts/src/types.nr`, `packages/contracts/src/test/darkforest_stub.nr` — core contract and type system updates (artifact/NFT logic, gameplay parity work).
- `tasks/` tickets for P0-P2 parity work exist and are tracked; `plan.md` enumerates remaining priorities.
- `review-2026-01-03-1917.md`, `review-2026-01-04-1451.md` — previous review snapshots (historical context).

## P0 / P1 / P2 Remaining Work (Per plan.md)
### P0 — Must Fix for Faithful, Safe v0.6
- **Completed:** 014 / 023 / 024 / 025 / 026.

### P1 — Performance + Integration
- **019** — Playable client integration (end-to-end UI verification for core actions).
- **020** — Performance measurement + devnet/local deploy docs.
- **027** — Headless E2E negative/edge cases.

### P2 — Quality + UX
- **028** — UX polish for trade/activation + NFT ownership.
- **029** — Logging/observability improvements.
- **030** — Optional indexing helpers for client state.

## Opinionated Assessment
- The project is **feature-complete for core mechanics** and now **P0 parity-complete**, but still needs P1/P2 integration polish and performance measurement.
- The E2E test is **solid and comprehensive**, but runtime is long. Shortening turn cycle times (empty blocks or faster sequencer config) is recommended once admin APIs are reliably available.
- The local-network bootstrapping in Aztec CLI makes testing easy but **reduces control** (no admin RPC). If admin APIs are required (e.g., faster block production), you’ll need a non-local-network node or a custom local-net harness.

## Immediate Next Steps
1. **Document local-network limitations** (admin RPC disabled) and E2E expectations (tick_block cadence / `SEQ_ENFORCE_TIME_TABLE=false`).
2. **Add negative-case E2E coverage** (ticket 027).
3. **Measure end-to-end latency** vs the <60s target and adjust network/test config accordingly.
4. **Continue playable client integration** (ticket 019) with full gameplay-loop verification.
