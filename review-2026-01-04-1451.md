# Dark Forest on Aztec — Repository Review (2026-01-04 14:51 local)

## Scope Reviewed
- Grant requirements: `grant_proposal.md`
- Current work queue: `tasks/021-030*.md`, `plan.md`
- Contract core: `packages/contracts/src/main.nr`, `packages/contracts/src/types.nr`
- Contract tests: `packages/contracts/src/test/darkforest_stub.nr`
- NFT contract: `packages/nft/src/main.nr`
- Headless E2E: `packages/contracts/scripts/e2e_darkforest.js`, `packages/contracts/scripts/hashing.js`
- Client chain decoding: `apps/client/src/scripts/chain.ts`
- Tooling updates: `packages/contracts/package.json`, `yarn.lock`

## Findings (ordered by severity)
1) **Critical — Trading post deposit/withdraw does not enforce NFT ownership.**
   - Any trading-post owner can deposit an artifact that is in someone else’s wallet because the only gate is `artifact_locations == 0` and `planet.owner == player`; the NFT transfer ignores the `from` parameter. This is a correctness + security issue (unauthorized asset seizure) and undermines NFT ownership as a source of truth.
   - Evidence: `packages/contracts/src/main.nr:1548-1591` (no NFT ownership checks), `packages/nft/src/main.nr:38-47` (transfer ignores `_from`).

2) **High — E2E script expects burned artifacts at location `0`, but contract now uses `max_location_id`.**
   - The headless E2E asserts `photoidLocation === 0n` and `shieldLocation === 0n`, but burn paths now set `artifact_locations` to `config.max_location_id` and `artifact.burned = true`. This will cause E2E failures once those paths are reached.
   - Evidence: `packages/contracts/scripts/e2e_darkforest.js:1439-1495` vs burn paths in `packages/contracts/src/main.nr:1677-1694` and `packages/contracts/src/main.nr:2045-2060`.

3) **High — E2E block ticking uses a full admin transaction (not empty blocks), leading to long runtimes and state mutation.**
   - `tickBlock` sends `admin_set_planet_owner` each time a block is needed. This is a proof-producing tx and can take tens of seconds per block; with multiple waits it can turn the E2E run into 30–40 minutes and it mutates state while waiting.
   - Evidence: `packages/contracts/scripts/e2e_darkforest.js:912-919`, `waitForBlock` uses `tickBlock` every 5 seconds (`packages/contracts/scripts/e2e_darkforest.js:753-771`).

4) **Medium — NFT “burn” is implemented as `transfer_in_public` to self, not a real burn.**
   - The NFT contract has a `burn` method, but burn paths call `nft_transfer(contract_addr, contract_addr, token_id)` which leaves the token owned by the contract (not zero address). This is ok as a “burn address” if intentional, but it’s not explicit and could confuse indexing or future transfers.
   - Evidence: burn logic in `packages/contracts/src/main.nr:1677-1694` and `packages/contracts/src/main.nr:2045-2060`; NFT burn is at `packages/nft/src/main.nr:50-53` but unused.

5) **Medium — Client and E2E decoders still assume 11-field `Artifact` and omit the new `burned` flag.**
   - The contract added `burned` to `Artifact`; off-chain decoders still read 11 fields and have no visibility into burn state. Not a runtime break, but it’s a correctness/UX gap and makes it harder to validate burn behavior.
   - Evidence: `packages/contracts/src/types.nr:250-303`, `apps/client/src/scripts/chain.ts:65-77` and `apps/client/src/scripts/chain.ts:305-318`; E2E decode is similar in `packages/contracts/scripts/e2e_darkforest.js` (artifact reads 11 fields).

6) **Low — Ticket status drift.**
   - `plan.md` lists ticket 021 as “Recent Completions,” but `tasks/021-review-and-e2e-integration-test.md` is still marked Pending and the E2E test is currently mismatched to burn semantics.
   - Evidence: `plan.md` and `tasks/021-review-and-e2e-integration-test.md`.

## Current Stage Assessment (Opinion)
The repo is **late core-logic / early integration & QA**. Contract parity has improved (burn semantics, init guard, wormhole arrival parity), tests reflect these fixes, and a full headless E2E script now exists. However, the E2E path still doesn’t complete reliably, and there is a **critical ownership gap** in trading-post flows. The client and E2E decoding are also lagging the contract’s `Artifact` schema. Net: this is very close to a faithful v0.6 port on-chain, but still **not production‑safe** until ownership is enforced and E2E reliability is fixed.

## What Has Been Changing (Recent Work)
- **Artifact lifecycle parity**: added `Artifact.burned`, set burn sentinel to `max_location_id`, and blocked use of burned artifacts; updated tests for bloom/black and photoid/shield burns.
- **Init guard hardening**: `init_player` now asserts the target planet is not already initialized; private nullifiers added for location/player to prevent same‑block duplicate claims.
- **Wormhole arrival parity**: `execute_arrival` now skips combat on wormhole arrivals to non‑owned planets (v0.6 parity), tests updated accordingly.
- **Headless E2E**: large end‑to‑end script added plus hashing helpers; `test:e2e` script added to contracts package.
- **Planning artifacts**: new tickets 021–030 and `plan.md` introduced.

## What’s Left (Priorities)
### P0 — Must Fix for a Faithful, Safe v0.6 Port
- **Enforce NFT ownership on trade flows** (close the deposit/withdraw ownership gap).
- **Finish ticket 021**: update E2E expectations for burn semantics and ensure it runs to completion on local devnet.
- **Ticket 026**: spaceship activation parity (use real ship artifacts, confirm activation effects, tests).

### P1 — Integration + Performance
- **Ticket 027**: E2E negative/edge cases (assert failures without hangs).
- **Ticket 020**: performance measurement + local/devnet docs for <60s target.
- **Ticket 019**: playable client integration verification across core actions.

### P2 — Quality + UX
- **Ticket 028**: UX polish for trade/activation, surface NFT ownership and burned state.
- **Ticket 029**: logging/observability improvements (client + scripts).
- **Ticket 030**: optional indexing helpers for client state hydration.

## Open Questions / Assumptions
- Should burns call `NFT.burn` (zero owner) or keep the current “burn‑address = contract” approach? If the latter, document explicitly and update client indexing assumptions.
- Do we want E2E to advance **empty blocks** (per local‑network docs) rather than using admin txs? If yes, we should swap `tickBlock` for a node‑level block trigger.

