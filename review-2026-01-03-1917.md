# Dark Forest on Aztec — Repository Review (2026-01-03 19:17 local)

## Scope Reviewed
- Grant scope + requirements: `grant_proposal.md`
- Progress status: `progress-2026-01-03-1653.md`
- Tickets and notes: `tasks/*.md`, `per_repo_diffs.md`
- Contracts: `packages/contracts/src/main.nr`, `packages/contracts/src/types.nr`, `packages/contracts/src/test/darkforest_stub.nr`
- NFT: `packages/nft/src/main.nr`
- Client: `apps/client/src/App.tsx`, `apps/client/src/scripts/*`
- Tooling: `packages/contracts/scripts/deploy_local.js`, workspace `package.json`

## What Has Been Built (Substantial Progress)
### Contract layer (Aztec Noir)
- Core Dark Forest v0.6 mechanics are ported into Noir with the expected private-validate → public-apply pattern.
- Core actions are present: init, reveal, move/capture, upgrades, prospect/find, trade, activation/deactivation, ships, arrivals.
- Storage layout mirrors the v0.6 model (planets, arrivals, artifacts, players, reveals).
- Public bytecode has been reduced under Aztec limits (per ticket 018) while keeping private validations.
- Noir test suite is extensive (`darkforest_stub.nr`) and exercises a wide range of mechanics.

### NFT contract
- Aztec-native NFT contract is implemented and wired into DarkForest mint/transfer/burn paths.
- Minting is used for artifacts and ships, and trading-post transfers call `transfer_in_public`.

### Client layer (React)
- Client connects to local Aztec node, registers DarkForest + NFT, reads on-chain config, and is usable for core actions.
- Actions are wired for init, reveal, move, upgrades, prospect/find, trade, activate.
- Chain storage readers exist for planets, players, artifacts, arrivals, and config.

### Tooling & Dev
- Local deploy script exists that deploys NFT + DarkForest and wires the minter.
- Vite bundling issue with bb-prover was resolved (VK lookup mismatch addressed).

## Current Stage Assessment (Opinion)
This repo is **late core-logic / early integration**. The Noir contract is functionally rich and close to a faithful v0.6 port, and the web client already exposes gameplay flows. However, *end-to-end validation is still narrow* (init/reveal only), performance is near the 60s target, and several correctness gaps remain in artifact/NFT handling. It is approaching a “playable prototype” but **not yet at a production-quality v0.6 parity bar**.

## Key Risks / Gaps (Most Important First)
1. **Trading post NFT ownership is not enforced**
   - `trade_artifact` does not verify NFT ownership; NFT `transfer_in_public` ignores `from`. A trading post owner can withdraw any artifact token. This is a correctness + security issue. (Refs: `packages/contracts/src/main.nr`, `packages/nft/src/main.nr`)

2. **“Burned” artifacts are not actually burned**
   - Bloom filter / black domain removals only clear planet storage and set location to 0; NFT is not burned and no “burned” flag exists. Artifacts can be re-deposited or reused. (Ref: `packages/contracts/src/main.nr`)

3. **Init allows claiming an already initialized planet**
   - `apply_player_action` for init does not block if `planets[location_id]` is already initialized. A player can claim a populated planet. (Ref: `packages/contracts/src/main.nr`)

4. **Wormhole arrival handling diverges from v0.6 expectation**
   - Wormhole arrivals are still resolved with normal combat in `execute_arrival`. Tests currently encode this behavior; if v0.6 expected no combat, parity gap exists.

5. **Artifact randomness uses deterministic pseudo-blockhash**
   - Artifact seed uses MiMC of block number. This is predictable and may deviate from v0.6 randomness assumptions.

6. **End-to-end coverage is incomplete**
   - Only init/reveal have been proven end-to-end with real proofs (per progress report). All other actions remain unverified against live Aztec node/pxe.

7. **Performance risk remains for the < 60s turn target**
   - init/reveal already hover at ~60–65s in local testing; other actions are unmeasured.

8. **Local dev reliability depends on Vite dependency graph**
   - VK cache mismatch was fixed but can regress with dependency changes.

## What’s Left (Prioritized)
### P0 — Must Fix for a Faithful, Safe, Playable v0.6 Port
- Enforce NFT ownership and transfer semantics in trading post flows.
- Fix artifact burn semantics: ensure burned artifacts can’t be reused and NFT is burned.
- Block init on already-initialized planets (or match v0.6 rules explicitly).
- Confirm wormhole combat behavior vs. v0.6 (align tests + implementation).
- Full end-to-end integration testing across all actions (no UI).

### P1 — Required for Target Performance + Robustness
- Measure and optimize proof + send + confirm times for all actions.
- Tune client + contract performance to keep single-turn under 60s.
- Broaden integration testing to cover failure cases and edge conditions.
- Strengthen local/devnet deployment docs and troubleshooting guidance.

### P2 — Quality, UX, and Operational Improvements
- UX polish for trade/activation feedback and NFT ownership views.
- Improve error reporting and logging across client + scripts.
- Optional: add indexing/indexer helpers for client state hydration.

## Overall Verdict
The project is in good shape for **core mechanics** and shows strong progress toward the grant non‑negotiables. The immediate blockers are **NFT correctness**, **artifact lifecycle rules**, and **full e2e validation**. Once these are addressed and proof performance is measured + optimized, the repo will be very close to a complete, faithful v0.6 port that is actually playable end‑to‑end.
